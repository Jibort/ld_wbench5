SÃ­ntesi Completa del Projecte Sabina (Flutter)
Ãšltima actualitzaciÃ³: 13 Maig 2025
Context General del Projecte
AplicaciÃ³: Sabina (ld_wbench5)
Framework: Flutter amb patrÃ³ MVC customitzat
GestiÃ³ d'estat: Sense dependencies externes (NO GetX, NO Provider)
Idiomes: Sistema d'internacionalitzaciÃ³ amb claus prefixades "##"
Tema: Sistema de temes personalitzables
Arquitectura Three-Layer Confirmada
Layer 1: Widget (ConfiguraciÃ³)

Utilitza mapes per passar configuraciÃ³
No contÃ© lÃ²gica ni estat
Delega tot al Controller

Layer 2: Controller (LÃ²gica)

Gestiona esdeveniments i actualitzacions UI
Crea i gestiona el model especÃ­fic
ContÃ© la lÃ²gica de negoci del widget

Layer 3: Model (Dades)

Emmagatzema estat persistent
Notifica automÃ ticament els observadors
Pattern Observer implementat

Problema Principal Resolt: Pantalla en Blanc
Error identificat:
type 'Null' is not a subtype of type 'String'
Causes i Solucions:

LdTextFieldModel constructor - RESOLT âœ…
LdTextFieldCtrl mÃ¨tode initialize - RESOLT âœ…
GestiÃ³ de valors null - RESOLT âœ…

Sistema de Constants
Prefixos del Sistema de Mapes:
dart// Propietats del Model (dades persistents)
const String mfText = 'mf_text';
const String mfInitialText = 'mf_initial_text';

// Propietats del Controlador (configuraciÃ³)
const String cfLabel = 'cf_label';
const String cfTag = 'cf_tag';

// Events (callbacks)
const String efOnPressed = 'ef_on_pressed';
const String efOnTextChanged = 'ef_on_text_changed';
LdTaggableMixin Funcionalitats
GestiÃ³ Dual d'Identificadors:
dartmixin LdTaggableMixin {
  String? _tag;                    // Per debugging i events
  GlobalKey? _globalKey;           // Per accÃ©s programÃ tic (lazy loading)
  
  // API de navegaciÃ³ integrada
  void navigateTo(Widget destination);
  void showSnackBar(String message);
}
Event System Detalls
EventBus:
dart// Emetre event a tag especÃ­fic
EventBus.s.emitToTag(
  LdEvent(eType: EventType.custom, eData: data),
  "target_widget_tag"
);

// Processar events amb filtratge per tag
void _handleEvent(LdEvent event) {
  if (event.isTargetedAt(tag)) {
    onEvent(event);
  }
}
Widgets - Estat Actual
Completats:

âœ… LdTextField - Completament refactoritzat i funcional

Constructor corregit
GestiÃ³ null-safe
IntegraciÃ³ Model-Controller confirmada



Pendents:

ğŸ”„ LdButton - Per refactoritzar
ğŸ”„ LdLabel - Per refactoritzar
ğŸ”„ LdScaffold - Per refactoritzar

Errors Comuns Identificats
1. Constructors incorrectes
dart// âŒ INCORRECTE
WidgetModel.fromMap(super.pMap) : super.fromMap() {

// âœ… CORRECTE  
WidgetModel.fromMap(LdMap<dynamic> pMap) : super.fromMap(pMap) {
2. AccÃ©s a propietats null
dart// âŒ INCORRECTE
String text = model.text;  // Pot ser null

// âœ… CORRECTE
String text = model.text ?? "";  // Valor per defecte
3. Override de mÃ¨todes inexistents
dart// âŒ INCORRECTE
@override
void _methodThatDoesntExist() {

// âœ… CORRECTE
// No posar @override si el mÃ¨tode no existeix al pare
void _privateMethod() {
4. CreaciÃ³ mÃºltiple de State

NO crear staat en constructors de widgets
Usar createState() adequadament
Evitar dispose() mÃºltiples

Normes d'Estil
1. Nomenclatura:
dart// Classes abstractes sempre acaben en "Abs"
class LdWidgetAbs {}
class LdWidgetCtrlAbs {}

// Controllers especÃ­fics NO porten "Abs"  
class LdTextFieldCtrl {}

// Models especÃ­fics tampoc
class LdTextFieldModel {}
2. Tipus GenÃ¨rics:
dart// âŒ EVITAR confusiÃ³ de tipus
Future<T> showDialog<T>()  // T pot confondre

// âœ… PREFERIT
Future<R?> showPageDialog<R>()  // R mÃ©s clar
3. GestiÃ³ d'Errors:
dart// Sempre implementar try-catch en operacions crÃ­tiques
try {
  model = WidgetModel.fromMap(config);
} catch (e) {
  Debug.error("$tag: Error: $e");
  model = WidgetModel.fromMap({});  // Fallback
}
4. Logging Consistent:
dartDebug.info("$tag: AcciÃ³ realitzada");
Debug.error("$tag: Error - $e");
Debug.warning("$tag: AdvertÃ¨ncia");
MapsService ImplementaciÃ³
GestiÃ³ IntelÂ·ligent:
dartclass MapsService {
  // Detecta duplicats automÃ ticament
  String registerMap(Map config);
  
  // Comte references automÃ tic
  void releaseMap(String id);
  
  // Cleanup automÃ tic quan ref count = 0
}
Decisions TÃ¨cniques Clau
1. OnceSet eliminat:

Massa complexitat sense benefici clar
Usar GlobalKey per accÃ©s al State

2. Constructors preferits:
dart// âœ… PREFERIT - amb mapa
MyWidget({String? pTag}) : super(config: {...});

// âŒ DEPRECAT  
@Deprecated("Usar constructor amb mapa")
MyWidget.old({Key? key}) : super.obsolete(key: key);
3. AccÃ©s Models:
dart// Widget accÃ©s segur al model
MyWidgetModel? get wModel => wCtrl?.model as MyWidgetModel?;

// Controller exposa model
LdWidgetModelAbs? get model => _model;
OptimitzaciÃ³ Performance
1. Lazy Loading:

GlobalKeys nomÃ©s es creen quan es necessiten
Models es carreguen sota demanda

2. GestiÃ³ MemÃ²ria:

Reference counting automÃ tic en MapsService
Disposal chains correctes

3. Notificacions Eficients:
dart// NomÃ©s notificar en canvis reals
void setText(String value) {
  if (_text != value) {  // Check abans de notify
    _text = value;
    notifyListeners(() {
      _text = value;
    });
  }
}
Patrons de Codi Evitats
1. Circular Updates:
dart// âœ… CORRECTE - Prevenir loops
bool _isUpdatingFromModel = false;

void _onTextChange() {
  if (_isUpdatingFromModel) return;
  // ... actualitzar model
}
2. Null Checks Defensius:
dart// âœ… CORRECTE
MyModel? get model => wCtrl?.model as MyModel?;

// âœ… CORRECTE - VersiÃ³ que garanteix non-null
MyModel get modelRequired {
  final model = this.model;
  assert(model != null, "$tag: Model no disponible");
  return model!;
}
Next Steps Recomanats

Refactoritzar widgets pendents seguint patrÃ³ LdTextField
Actualitzar TestPage per provar nova arquitectura
Revisar imports i eliminar referÃ¨ncies obsoletes
Afegir tests unitaris per verificar funcionament
Performance profiling si cal optimitzar

Estructura de Fitxers
lib/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ map_fields.dart       // Constants del sistema
â”‚   â”œâ”€â”€ event_bus/            // Sistema d'esdeveniments
â”‚   â””â”€â”€ services/             // MapsService, etc.
â”œâ”€â”€ ui/
â”‚   â””â”€â”€ widgets/
â”‚       â”œâ”€â”€ ld_text_field/    // âœ… COMPLETAT
â”‚       â”œâ”€â”€ ld_button/        // ğŸ”„ PENDENT
â”‚       â”œâ”€â”€ ld_label/         // ğŸ”„ PENDENT
â”‚       â””â”€â”€ ld_scaffold/      // ğŸ”„ PENDENT
â””â”€â”€ utils/
    â””â”€â”€ debug.dart            // Logging system
Recordatoris Importants

SEMPRE usar valors per defecte per evitar nulls
NO usar @override sense verificar l'existÃ¨ncia del mÃ¨tode pare
Cridar super.initialize() si el pare el tÃ©
Implementar dispose chains correctament
Afegir logging per debugging
Validar configuracions antes d'usar-les