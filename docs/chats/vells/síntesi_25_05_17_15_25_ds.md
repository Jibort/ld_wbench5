# S√≠ntesi Completa del Projecte Sabina - Actualitzaci√≥ 18 de Maig 2025
Data: 18 de maig de 2025 - Conversa amb Claude
Projecte: Sabina (ld_wbench5) - Flutter Framework
Versi√≥: 1.2.2

üìã Context General del Projecte
Objectiu del Projecte
Sabina √©s un framework Flutter personalitzat que implementa una arquitectura MVC de tres capes, amb un sistema avan√ßat de traduccions i gesti√≥ d'estat sense dependencies externes.

Arquitectura Implementada
- Framework: Flutter amb patr√≥ MVC customitzat (Three-Layer)
- Gesti√≥ d'estat: Sense dependencies externes (NO GetX, NO Provider)
- Sistema de traduccions: Claus prefixades amb "##", gesti√≥ via StringTx.tx()
- Mapes: √ös de LdMap<T> en lloc de Map<String, T> arreu del projecte

Arquitectura Three-Layer
1. Widget Layer: Nom√©s configuraci√≥, delega al controller
   - Fitxers: *_widget.dart
   - Responsabilitat: Configuraci√≥ UI, delegaci√≥ al controller

2. Controller Layer: Gestiona l√≤gica, events i crea models
   - Fitxers: *_ctrl.dart
   - Responsabilitat: L√≤gica de negoci, gesti√≥ d'eventos, creaci√≥ de models

3. Model Layer: Estat persistent amb pattern Observer
   - Fitxers: *_model.dart
   - Responsabilitat: Estat de dades, notificacions de canvis

üèó M√≤duls Principals

Core Components
- LdWidgetAbs: Classe base per tots els widgets
- LdWidgetCtrlAbs: Classe base per controllers
- LdWidgetModelAbs: Classe base per models
- LdModelObserverIntf: Interf√≠cie per observar canvis

Widgets Implementats
- LdButton: Bot√≥ amb traduccions i eventos
- LdLabel: Etiqueta amb suport RichText
- LdTextField: Camp de text (en desenvolupament)
- LdThemeSelector: Selector de temes complet
- LdThemeViewer: Visualitzador de propietats de tema
- LdAppBar: AppBar personalitzada amb traduccions
- LdScaffold: Scaffold unificat amb l'arquitectura

Serveis
- TimeService: Gesti√≥ del temps amb observers
- L (LanguageService): Gesti√≥ d'idiomes i traduccions
- ThemeService: Servei unificat de gesti√≥ de temes (ara √∫nic, LdTheme eliminat)
- GlobalVariablesService: Variables autom√†tiques per interpolaci√≥
- MapsService: Gesti√≥ centralitzada de mapes de configuraci√≥

üéØ Problemes Recents Resolts

Problema de Rendiment amb LdLabels Reactius (Resolt) ‚≠êÔ∏è
- S√≠mptoma: La p√†gina de test es reconstru√Øa completament cada 500ms, causant problemes de rendiment
- Causa: El `setState()` al function observer `_obsTimer` reconstru√Øa tota la p√†gina en lloc de nom√©s el LdLabel
- Soluci√≥: Implementaci√≥ d'un m√®tode `setTranslationArgsIsolated()` per actualitzar nom√©s l'LdLabel espec√≠fic
- Impacte: Millora significativa en rendiment, sobretot en dispositius de gamma mitjana/baixa

Problema de Duplicitat de Serveis (Resolt)
- S√≠mptoma: Dos serveis redundants (LdTheme i ThemeService) 
- Causa: Implementacions paral¬∑leles amb funcionalitat similar
- Soluci√≥: Unificaci√≥ en ThemeService √∫nic, eliminaci√≥ de LdTheme

Error en Gesti√≥ de Temes (Resolt)
- S√≠mptoma: Variables privades declarades per√≤ no usades en ThemeService
- Causa: Problemes en la implementaci√≥ del patr√≥ singleton i notificacions
- Soluci√≥: Implementaci√≥ correcta amb ValueNotifier i √∫s de singletons

Problema amb APIs Obsoletes (Resolt)
- S√≠mptoma: √ös de par√†metres deprecats de ColorScheme (background, onBackground)
- Causa: Codi escrit sense actualitzar a les darreres recomanacions de Flutter
- Soluci√≥: Refactoritzaci√≥ amb √∫s de surface i onSurface en lloc dels deprecats

Problema LdLabels Reactius (Resolt) ‚≠êÔ∏è
- Context: LdLabels amb arguments d'interpolaci√≥ no s'actualitzaven quan canviaven les dades del model
- S√≠mptomes: Etiquetes d'hora, comptadors i idioma no s'actualitzaven correctament
- Soluci√≥ implementada: Patr√≥ Function Observer amb setTranslationArgs()
- Regla d'Or: Qualsevol LdLabel que mostri dades que canvien SEMPRE necessita un function observer dedicat

üÜï Actualitzacions d'Aquesta Conversa (18 maig 2025)

Optimitzaci√≥ de Rendiment: LdLabel amb Reconstrucci√≥ A√Øllada ‚≠êÔ∏è
1. **Nova funcionalitat `setTranslationArgsIsolated`**: Afegit a `LdLabel` per permetre actualitzacions que no reconstrueixin tot el controlador pare
   - Resol problemes de rendiment amb components que s'actualitzen freq√ºentment (com el TimeService, que emet events cada 500ms)
   - Implementa un patr√≥ d'a√Øllament de reconstruccions a nivell de widget

2. **Correcci√≥ d'Errors relacionats amb WidgetsBinding.addPostFrameCallback**:
   - Identificat i documentat el problema de reconstruccions c√≠cliques quan aquest m√®tode s'utilitza dins de `build()`
   - Establert el patr√≥ correcte d'√∫s a `initState()` o amb bandera est√†tica

3. **Actualitzaci√≥ de la Documentaci√≥**:
   - Normes d'estil actualitzades per incloure optimitzacions de rendiment
   - Document d'errors comuns ampliat amb secci√≥ espec√≠fica d'errors de rendiment
   - Actualitzaci√≥ de la s√≠ntesi del projecte per reflectir aquests aven√ßos

Millores al Document d'Errors Comuns
- **Nous errors documentats**: Errors de reconstrucci√≥ excessiva, √∫s incorrecte de callbacks, etc.
- **Secci√≥ espec√≠fica d'Errors de Rendiment**: Per prevenir problemes similars en el futur
- **Exemples ampliats**: M√©s exemples concrets per il¬∑lustrar els errors i les solucions correctes

üìÅ Documents del Projecte

Fitxers Obligatoris per Cada Nova Conversa:
1. **S√≠ntesi de converses** (aquest document)
2. **Normes d'estil** (document independent)
3. **Errors comuns** (document independent)

Aquests tres documents garanteixen continu√Øtat i qualitat en cada nova sessi√≥.

üèó Sistema de Traduccions i Interpolaci√≥

Classes Clau
- StringTx: Gesti√≥ de traduccions amb interpolaci√≥
- Extensions String: Simplificaci√≥ d'√∫s (.tx, .txWith, .txArgs)
- GlobalVariablesService: Variables autom√†tiques per interpolaci√≥

Suport per Par√†metres
- Posicionals: {0}, {1}, etc.
- Nomenats: {name}, {count}, etc.
- Variables autom√†tiques: {current_date}, {user_name}, etc.

üîß Components Clau Implementats

TimeService amb Model Observable
- Sincronitzaci√≥ amb servidor cada 30 segons
- Actualitzaci√≥ local cada 500ms
- Pattern Observer per notificar canvis

ThemeService - Sistema Unificat de Temes
- 8 temes predefinits (Sabina, Natura, Foc, Nit, Custom1, Custom2, DexeusClear, DexeusDark)
- Suport per modes (clar, fosc, sistema)
- Implementaci√≥ robusta amb ValueNotifier i fallbacks
- Selector i visualitzador de temes integrats

Sistema d'Events
- EventBus centralitzat
- Suport per events targetsats i globals
- Gesti√≥ de languageChanged, themeChanged, rebuildUI

üìã Patrons Optimitzats per Components Reactius

### Patr√≥ Standard per LdLabels Reactius ‚≠êÔ∏è

```dart
// 1. Crear LdLabel
labTime = LdLabel(
  key: ValueKey(tagLabTime), 
  pTag: tagLabTime,
  pLabel: L.sCurrentTime,
  pPosArgs: [TimeService.s.model.formattedTime],
  style: Theme.of(context).textTheme.bodyMedium,
);

// 2. Crear Function Observer dedicat
_obsTimer = (LdModelAbs pModel, void Function() pfnUpdate) {
  if (pModel == TimeService.s.model && mounted) {
    final time = TimeService.s.model.formattedTime;
    
    if (labTime != null) {
      pfnUpdate();
      
      // Per components freq√ºentment actualitzats (com hora)
      labTime!.setTranslationArgsIsolated(positionalArgs: [time]);
      
      // Per components menys freq√ºentment actualitzats
      // setState(() {
      //   labTime!.setTranslationArgs(positionalArgs: [time]);
      // });
    }
  }
};

// 3. Connectar Function Observer (MAI connectar directament)
TimeService.s.model.attachObserverFunction(_obsTimer);

// 4. Desconnectar al dispose()
@override
void dispose() {
  TimeService.s.model.detachObserverFunction(_obsTimer);
  super.dispose();
}
```

### Patr√≥ per Evitar Reconstruccions Excessives ‚≠êÔ∏è

```dart
// ‚ùå INCORRECTE - Causa reconstruccions en cadena
@override
Widget buildPage(BuildContext context) {
  WidgetsBinding.instance.addPostFrameCallback((_) {
    _updateControllerReferences();
  });
  
  // ... resta del codi
}

// ‚úÖ CORRECTE - Actualitzaci√≥ √∫nica despr√©s del primer frame
@override
void initState() {
  super.initState();
  
  WidgetsBinding.instance.addPostFrameCallback((_) {
    _updateControllerReferences();
  });
}
```

### Beneficis del Nou Patr√≥ Optimitzat

1. **Rendiment millorat**: Components que s'actualitzen freq√ºentment (com l'hora) ja no causen reconstruccions innecess√†ries
2. **Escalabilitat**: S'eviten colls d'ampolla en UI amb m√∫ltiples components din√†mics
3. **Consist√®ncia**: Patr√≥ unificat per a tots els LdLabels reactius
4. **Mantenibilitat**: Separaci√≥ clara de responsabilitats

üöÄ Estat Actual i Pr√≤xims Passos

‚úÖ Completat
- ‚úì Arquitectura three-layer estable i documentada
- ‚úì Sistema de traduccions amb interpolaci√≥ avan√ßada
- ‚úì Pattern Observer per LdLabels reactius
- ‚úì Gesti√≥ de temes completa (ThemeService)
- ‚úì Documentaci√≥ independent d'estil i errors
- ‚úì Widgets principals implementats
- ‚úì Refactoritzaci√≥ i unificaci√≥ de serveis de tema
- ‚úì Eliminaci√≥ de par√†metres deprecats de ColorScheme
- ‚úì Optimitzaci√≥ de rendiment per a LdLabels din√†mics

üìã Activitats Actuals
- ‚úì Revisi√≥ sistem√†tica de codi mort i sintaxi millorable
- ‚úì Documentaci√≥ de codi important no existent
- ‚úì Fase de planificaci√≥ per simplificar i completar components
- ‚úì Optimitzaci√≥ de rendiment, especialment amb components d'alta freq√º√®ncia d'actualitzaci√≥

üìã Backlog Prioritat Mitjana
- Completar implementaci√≥ RichText en LdLabel
- Resoldre problemes visuals de selecci√≥ de tema
- Implementar tests unitaris per components principals
- Optimitzar rendiment global de l'arquitectura

üîß Millores Futures
- Implementar sistema de logs m√©s robust
- Afegir support per themes din√†mics
- Crear documentaci√≥ autom√†tica dels widgets
- Implementar testing framework espec√≠fic per l'arquitectura
- Millorar les optimitzacions de rendiment per a components complexos

üìù Notes per Sessions Futures

Recordatoris Importants
‚ö†Ô∏è **OBLIGATORI**: Sempre rebre tres fitxers al comen√ßar nova conversa:
1. S√≠ntesi de converses (aquest document)
2. Normes d'estil (document independent)
3. Errors comuns (document independent)

Caracter√≠stiques Clau a Recordar
- Patr√≥ Function Observer per LdLabels reactius (SEMPRE)
- √ös de `setTranslationArgsIsolated` per actualitzacions freq√ºents
- Doble revisi√≥ obligat√≤ria abans de lliurar codi
- Constants cf/mf/ef segons funcionalitat
- Imports sempre amb package complet
- Comentaris //JIQ>CLA s'eliminen autom√†ticament
- Dates de creaci√≥ sempre es preserven en cap√ßaleres de fitxers

Context del Domini
Sabina demostra una arquitectura Flutter avan√ßada amb:
- Gesti√≥ d'estat reactiva sense dependencies
- Sistema de traduccions i internacionalitzaci√≥ complet
- Pattern MVC adaptat per Flutter
- Componentitzaci√≥ amb separation of concerns
- Optimitzaci√≥ de rendiment a nivell de widget

Regles d'Or del Projecte ‚≠êÔ∏è
1. Qualsevol LdLabel que mostri dades que canvien SEMPRE necessita un function observer dedicat.
2. Per dades que canvien freq√ºentment (>1 vegada/s) utilitzar `setTranslationArgsIsolated` per evitar reconstruccions innecess√†ries.
3. NO invocar mai `WidgetsBinding.instance.addPostFrameCallback` dins de m√®todes `build()`.
4. NO connectar mai directament un LdLabel com a observador d'un model; sempre utilitzar un function observer dedicat.
