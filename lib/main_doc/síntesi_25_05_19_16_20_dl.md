# S铆ntesi Completa del Projecte Sabina - Actualitzaci贸 19 de Maig 2025
Data: 19 de maig de 2025 - Conversa amb Claude
Projecte: Sabina (ld_wbench5) - Flutter Framework
Versi贸: 1.2.6

 Context General del Projecte
Objectiu del Projecte
Sabina 茅s un framework Flutter personalitzat que implementa una arquitectura MVC de tres capes, amb un sistema avan莽at de traduccions i gesti贸 d'estat sense dependencies externes.

Arquitectura Implementada
- Framework: Flutter amb patr贸 MVC customitzat (Three-Layer)
- Gesti贸 d'estat: Sense dependencies externes (NO GetX, NO Provider)
- Sistema de traduccions: Claus prefixades amb "##", gesti贸 via StringTx.tx()
- Mapes: s de LdMap<T> en lloc de Map<String, T> arreu del projecte

Arquitectura Three-Layer
1. Widget Layer: Nom茅s configuraci贸, delega al controller
   - Fitxers: *_widget.dart
   - Responsabilitat: Configuraci贸 UI, delegaci贸 al controller

2. Controller Layer: Gestiona l貌gica, events i crea models
   - Fitxers: *_ctrl.dart
   - Responsabilitat: L貌gica de negoci, gesti贸 d'eventos, creaci贸 de models

3. Model Layer: Estat persistent amb pattern Observer
   - Fitxers: *_model.dart
   - Responsabilitat: Estat de dades, notificacions de canvis

 M貌duls Principals

Core Components
- LdWidgetAbs: Classe base per tots els widgets
- LdWidgetCtrlAbs: Classe base per controllers
- LdWidgetModelAbs: Classe base per models
- LdModelObserverIntf: Interf铆cie per observar canvis

Widgets Implementats
- LdButton: Bot贸 amb traduccions i eventos
- LdLabel: Etiqueta amb suport RichText
- LdTextField: Camp de text (en desenvolupament)
- LdThemeSelector: Selector de temes complet
- LdThemeViewer: Visualitzador de propietats de tema
- LdAppBar: AppBar personalitzada amb traduccions
- LdScaffold: Scaffold unificat amb l'arquitectura
- LdFoldableContainer: Contenidor plegable amb gesti贸 d'estat i animaci贸

Serveis
- TimeService: Gesti贸 del temps amb observers
- L (LanguageService): Gesti贸 d'idiomes i traduccions
- ThemeService: Servei unificat de gesti贸 de temes (ara 煤nic, LdTheme eliminat)
- GlobalVariablesService: Variables automtiques per interpolaci贸
- MapsService: Gesti贸 centralitzada de mapes de configuraci贸

 Problemes Recents Resolts

Problema de Rendiment amb LdLabels Reactius (Resolt) 猸锔
- S铆mptoma: La pgina de test es reconstru茂a completament cada 500ms, causant problemes de rendiment
- Causa: El `setState()` al function observer `_obsTimer` reconstru茂a tota la pgina en lloc de nom茅s el LdLabel
- Soluci贸: Implementaci贸 d'un m猫tode `setTranslationArgsIsolated()` per actualitzar nom茅s l'LdLabel espec铆fic
- Impacte: Millora significativa en rendiment, sobretot en dispositius de gamma mitjana/baixa

Problema de Duplicitat de Serveis (Resolt)
- S铆mptoma: Dos serveis redundants (LdTheme i ThemeService) 
- Causa: Implementacions paral路leles amb funcionalitat similar
- Soluci贸: Unificaci贸 en ThemeService 煤nic, eliminaci贸 de LdTheme

Error en Gesti贸 de Temes (Resolt)
- S铆mptoma: Variables privades declarades per貌 no usades en ThemeService
- Causa: Problemes en la implementaci贸 del patr贸 singleton i notificacions
- Soluci贸: Implementaci贸 correcta amb ValueNotifier i 煤s de singletons

Problema amb APIs Obsoletes (Resolt)
- S铆mptoma: s de parmetres deprecats de ColorScheme (background, onBackground)
- Causa: Codi escrit sense actualitzar a les darreres recomanacions de Flutter
- Soluci贸: Refactoritzaci贸 amb 煤s de surface i onSurface en lloc dels deprecats

Problema LdLabels Reactius (Resolt) 猸锔
- Context: LdLabels amb arguments d'interpolaci贸 no s'actualitzaven quan canviaven les dades del model
- S铆mptomes: Etiquetes d'hora, comptadors i idioma no s'actualitzaven correctament
- Soluci贸 implementada: Patr贸 Function Observer amb setTranslationArgs()
- Regla d'Or: Qualsevol LdLabel que mostri dades que canvien SEMPRE necessita un function observer dedicat

Actualitzacions 19 maig 2025 - Resoluci贸 de Problemes amb LdFoldableContainer
[Contingut original de l'apartat]

 Sistema de Traduccions i Interpolaci贸
[Contingut original de l'apartat]

 Components Clau Implementats
[Contingut original de l'apartat]

 Patrons Optimitzats per Components Reactius
[Contingut original de l'apartat]

 Estat Actual i Pr貌xims Passos
[Contingut original de l'apartat]

## Evoluci贸 Arquitect貌nica dels Models

### Problema Inicial
- Multiplicitat de classes abstractes de models
- Complexitat en l'her猫ncia i gesti贸 de models
- Duplicaci贸 de codi i estructura

### Soluci贸 Arquitect貌nica

#### LdModelAbs: Contenidor Central de Models
- **Funcionalitat Principal**:
  1. Gesti贸 centralitzada de mapes de dades
  2. Integraci贸 amb `StatePersistenceService`
  3. Generaci贸 i gesti贸 de tags 煤nics

#### Caracter铆stiques Clau

1. **Gesti贸 de Mapes**
   - Emmagatzemament local del mapa de dades
   - Acc茅s i modificaci贸 via m猫todes gen猫rics
   - Persist猫ncia automtica

2. **Generaci贸 de Tags**
   ```dart
   abstract class LdModelAbs with LdTaggableMixin {
     LdModelAbs({String? pTag}) {
       tag = pTag ?? generateTag();
     }

     // M猫tode de generaci贸 de tag per defecte
     String generateTag() => LdTaggableMixin.customTag(runtimeType.toString());
   }
   ```

3. **M猫todes Principals**
   - `getField<T>()`: Recuperaci贸 de valors
   - `setField<T>()`: Modificaci贸 de valors
   - Persist猫ncia automtica en cada modificaci贸

4. **Eliminaci贸 de Capes Interm猫dies**
   - Eliminaci贸 de `LdWidgetModelAbs`
   - Eliminaci贸 de `LdPageModelAbs`
   - Extensi贸 directa des de `LdModelAbs`

### Exemple de Model Espec铆fic

```dart
class LdTextFieldModel extends LdModelAbs {
  LdTextFieldModel({
    String? pTag,
    String? initialText,
    bool enabled = true,
  }) : super(pTag: pTag) {
    // Inicialitzaci贸 amb valors per defecte
    setField(mfText, initialText ?? '');
    setField(cfIsEnabled, enabled);
  }

  // Getters semntics
  String get text => getField(mfText) ?? '';
  set text(String value) => setField(mfText, value);
}
```

### Avantatges de la Nova Arquitectura
- Simplificaci贸 de l'estructura de models
- Reducci贸 de la duplicaci贸 de codi
- Millor encapsulament
- Persist猫ncia integrada
- Generaci贸 automtica de tags
- Flexibilitat en l'extensi贸

### Consideracions Importants
- Manteniment de la c貌pia local del mapa
- s de `StatePersistenceService` com a mecanisme de persist猫ncia
- Generaci贸 automtica de tags
- Acc茅s al mapa sempre a trav茅s del model

*Document actualitzat per documentar l'evoluci贸 del projecte Sabina.*
